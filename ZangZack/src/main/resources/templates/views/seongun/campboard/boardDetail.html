<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>게시글 상세보기</title>
	<link rel="stylesheet" href="css/seongun/boardDetail.css">
	<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
</head>
<link rel="shortcut icon" href="#">
<body>
	<div th:replace="~{common/navbar :: navbar}"></div>
	<div class="container">
		<div class="article_header">
			<span class="boardCategory">[[${bList.categoryName}]]</span>
			<div class="post-header">
				<h2>[[${bList.cbTitle}]]</h2>
				<div class="post-details">
					<img class="author-profile" th:src="${bList.memberProfilePath}"
						alt="작성자 프로필 이미지" />
					<div class="profile_area">
						<span class="author-name">[[${bList.memberName}]]</span>
						<div class="article_info">
							<span class="post-date">[[${bList.cbCreateDate}]]</span> 
							<span class="post-views">조회수: [[${bList.cbCount}]]</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="post-content">
			<p>[[${bList.cbContent}]]</p>
			<th:block th:if="${!pList.isEmpty}">
				<img th:src="${p.photoPath}" alt="게시글 이미지" th:each="p : ${pList}">
			</th:block>
		</div>
		<div class="comments-section">
			<div class="post-details">
				<div class="post-like-comment">
					<img src="image/seongun/offheart.png" alt="좋아요" class="like-button" onclick="increaseLikeCount()"> <span class="like-text">좋아요</span>
					<span class="like-count">[[${bList.heartCount}]]</span> 
					<span class="comment-text">댓글</span>
					<span class="comment-count">[[${bList.replyCount}]]</span>
				</div>
			</div>

			<!-- 댓글 목록 -->
			<div class="comment-box">
				<th:block th:if="${!rList.isEmpty}">
					<h3 class="comment-title">댓글</h3>
					<div class="comment-list">
						<!-- 각 댓글 항목 -->
						<div class="comment-item" th:each="r : ${rList}">
							<img class="comment-thumb" th:src="${r.memberProfilePath}" alt="프로필 사진">
							<div class="comment-content">
								<div class="comment-author">[[${r.memberName}]]</div>
								<div class="comment-message">[[${r.replyContent}]]</div>
								<div class="comment-info">[[${#dates.format(r.replyCreateDate, 'yyyy-MM-dd HH:mm')}]]</div>
							</div>
						</div>
						<!-- 추가 댓글 항목들 -->
					</div>
					<div id="commentList"></div>
				</th:block>
				<th:block th:if="${rList.isEmpty}">
					<h3 class="comment-title">댓글</h3>
					<div class="comment-item" style="display: block; border:none;">
						<div class="comment-message" style="text-align: center; color:black; display:block;">아직 작성된 댓글이 없습니다.</div>
					</div>
				</th:block>
				<div class="comment-form" th:if="${session.loginUser != null}">
					<textarea class="comment-input" placeholder="댓글을 남겨보세요" id="replyContent"></textarea>
					<button type="button" class="comment-submit" id="insertReply">등록</button>
				</div>
			</div>
		</div>
	</div>
	<script th:inline="javascript">
		// 페이지 로드 시 댓글 목록 불러오기
		window.onload = function() {
		    loadCommentList();
		};
	
		// 댓글 목록 불러오는 함수
		function loadCommentList(replyPage = 1) {
		    $.ajax({
		        url: 'selectReplyList.rep', // 서버의 댓글 목록 불러오기 URL
		        method: 'GET',
		        data: { replyPage: replyPage },
		        success: function(data) {
		            updateCommentList(data.comments);
		            updatePagination(data.pageInfo);
		        },
		        error: function(error) {
		            console.error('Error loading comments:', error);
		        }
		    });
		}
	
		// 댓글 추가 함수
		/*<![CDATA[*/
		document.getElementById('insertReply').addEventListener('click', function() {
		    const replyContent = document.getElementById('replyContent').value.trim();
		    if (replyContent === '') {
		        alert('댓글을 입력해주세요!');
		        return;
		    }
	
		    $.ajax({
		        url: 'insertReply.rep',
		        method: 'POST',
		        data: {
		            replyContent: replyContent,
		            boardNo: /*[[${bList.cbNo}]]*/1, // 예시로 1을 사용, 실제로는 동적으로 설정해야 함
		            boardType: 1 // 예시로 1을 사용, 실제로는 동적으로 설정해야 함
		        },
		        success: function(data) {
		            loadCommentList();
		            document.getElementById('replyContent').value = '';
		        },
		        error: function(error) {
		            console.error('Error adding comment:', error);
		        }
		    });
		});
		/*]]>*/
		function updateCommentList(comments) {
		    const commentList = document.getElementById('commentList');
		    commentList.innerHTML = '';
	
		    comments.forEach(function(comment) {
		        const commentItem = document.createElement('div');
		        commentItem.classList.add('comment-item');
	
		        const img = document.createElement('img');
		        img.classList.add('comment-thumb');
		        img.src = comment.memberProfilePath;
		        img.alt = '프로필 사진';
		        commentItem.appendChild(img);
	
		        const contentDiv = document.createElement('div');
		        contentDiv.classList.add('comment-content');
	
		        const authorDiv = document.createElement('div');
		        authorDiv.classList.add('comment-author');
		        authorDiv.textContent = comment.memberName;
		        contentDiv.appendChild(authorDiv);
	
		        const messageDiv = document.createElement('div');
		        messageDiv.classList.add('comment-message');
		        messageDiv.textContent = comment.replyContent;
		        contentDiv.appendChild(messageDiv);
	
		        const infoDiv = document.createElement('div');
		        infoDiv.classList.add('comment-info');
		        infoDiv.textContent = formatDate(comment.replyCreateDate);
		        contentDiv.appendChild(infoDiv);
	
		        commentItem.appendChild(contentDiv);
		        commentList.appendChild(commentItem);
		    });
		}
	
		function updatePagination(pageInfo) {
		    const paginationDiv = document.getElementById('pagenation');
		    paginationDiv.innerHTML = '';
	
		    if (pageInfo.currentPage > 1) {
		        const prevLi = document.createElement('li');
		        const prevLink = document.createElement('a');
		        prevLink.href = '#';
		        prevLink.textContent = '< 이전';
		        prevLink.onclick = function() {
		            loadCommentList(pageInfo.currentPage - 1);
		        };
		        prevLi.appendChild(prevLink);
		        paginationDiv.appendChild(prevLi);
		    }
	
		    for (let i = 1; i <= pageInfo.maxPage; i++) {
		        const pageLi = document.createElement('li');
		        const pageLink = document.createElement('a');
		        pageLink.href = '#';
		        pageLink.textContent = i;
		        if (i === pageInfo.currentPage) {
		            pageLink.classList.add('active');
		        }
		        pageLink.onclick = function() {
		            loadCommentList(i);
		        };
		        pageLi.appendChild(pageLink);
		        paginationDiv.appendChild(pageLi);
		    }
	
		    if (pageInfo.currentPage < pageInfo.maxPage) {
		        const nextLi = document.createElement('li');
		        const nextLink = document.createElement('a');
		        nextLink.href = '#';
		        nextLink.textContent = '다음 >';
		        nextLink.onclick = function() {
		            loadCommentList(pageInfo.currentPage + 1);
		        };
		        nextLi.appendChild(nextLink);
		        paginationDiv.appendChild(nextLi);
		    }
		}
	
		function formatDate(dateString) {
		    const date = new Date(dateString);
		    return date.getFullYear() + '-' + 
		           (date.getMonth() + 1).toString().padStart(2, '0') + '-' + 
		           date.getDate().toString().padStart(2, '0') + ' ' + 
		           date.getHours().toString().padStart(2, '0') + ':' + 
		           date.getMinutes().toString().padStart(2, '0');
		}

	</script>
</body>
</html>
