<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>게시글 상세보기</title>
	<link rel="stylesheet" href="css/seongun/boardDetail.css">
	<link rel="stylesheet" href="css/seongun/common/paging.css">
	<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
</head>
<link rel="shortcut icon" href="#">
<body>
	<div th:replace="~{common/navbar :: navbar}"></div>
	<div class="container">
		<div class="article_header">
			<span class="boardCategory">[[${bList.categoryName}]]</span>
			<div class="post-header">
				<h2>[[${bList.cbTitle}]]</h2>
				<div class="post-details">
					<img class="author-profile" th:src="${bList.memberProfilePath}"
						alt="작성자 프로필 이미지" />
					<div class="profile_area">
						<span class="author-name">[[${bList.memberName}]]</span>
						<div class="article_info">
							<span class="post-date">[[${bList.cbCreateDate}]]</span> 
							<span class="post-views">조회수: [[${bList.cbCount}]]</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="post-content">
			<p>[[${bList.cbContent}]]</p>
			<th:block th:if="${!pList.isEmpty}">
				<img th:src="${p.photoPath}" alt="게시글 이미지" th:each="p : ${pList}">
			</th:block>
		</div>
		<div class="comments-section">
			<div class="post-details">
				<div class="post-like-comment">
					<img src="image/seongun/offheart.png" alt="좋아요" class="like-button" onclick="increaseLikeCount()"> <span class="like-text">좋아요</span>
					<span class="like-count">[[${bList.heartCount}]]</span> 
					<span class="comment-text">댓글</span>
					<span class="comment-count">[[${bList.replyCount}]]</span>
				</div>
			</div>

			<!-- 댓글 목록 -->
			<div class="comment-box">
				<h3 class="comment-title">댓글</h3>
				<div id="commentList"></div>
				<div class="comment-list"></div>
				<div class="comment-form" th:if="${session.loginUser != null}">
					<textarea class="comment-input" placeholder="댓글을 남겨보세요" id="replyContent"></textarea>
					<button type="button" class="comment-submit" id="insertReply">등록</button>
				</div>
				<div id="pagenation"></div>
			</div>
		</div>
	</div>
	<script th:inline="javascript">
		/*<![CDATA[*/
		let member = /*[[${session.loginUser}]]*/null;
		/*]]>*/
		if(member != null){
			var memberId = member.memberId;
		}
		
		increaseLikeCount = () =>{
			
		}
		/*<![CDATA[*/
		// 페이지 로드 시 댓글 목록 불러오기
		window.onload = function() {
			loadCommentList(/*[[${maxPage}]]*/);
		};
		/*]]>*/
	
		// 댓글 목록 불러오는 함수
		
		
		/*<![CDATA[*/
		function loadCommentList(replyPage) {
		    $.ajax({
		        url: 'replyLimitList.rep', // 서버의 댓글 목록 불러오기 URL
		        method: 'GET',
		        data: { 
		        	page: replyPage,
		            boardNo: /*[[${bList.cbNo}]]*/1, 
		            boardType: 1 
		        	
		        },
		        success: function(data) {
		        	 console.log('Received data:', formatDate(data.list[0].replyCreateDate));
		            updateCommentList(data.list);
		            updatePagination(data.rPi);
		        },
		        error: function(error) {
		            console.error('Error loading comments:', error);
		        }
		    });
		}
		/*]]>*/
		
		// 댓글 추가 함수
		/*<![CDATA[*/
		document.addEventListener('DOMContentLoaded', function() {
		    var insertReplyButton = document.getElementById('insertReply');
		    if (insertReplyButton) {
		        insertReplyButton.addEventListener('click', function() {
		            const replyContent = document.getElementById('replyContent').value.trim();
		            if (replyContent === '') {
		                alert('댓글을 입력해주세요!');
		                return;
		            }
		
		            $.ajax({
		                url: 'insertReply.rep',
		                method: 'POST',
		                data: {
		                    replyContent: replyContent,
		                    boardNo: /*[[${bList.cbNo}]]*/1, // 예시로 1을 사용, 실제로는 동적으로 설정해야 함
		                    boardType: 1 
		                },
		                success: function(data) {
		                    loadCommentList(data.maxPage);
		                    document.getElementById('replyContent').value = '';
		                },
		                error: function(error) {
		                	alert("댓글을 500자 이내로 입력해주세요!");
		                }
		            });
		        });
		    }
		});
		/*]]>*/

		
		//댓글 list
		function updateCommentList(comments) {
		    const commentList = document.getElementById('commentList');
		    commentList.innerHTML = '';
		
		    comments.forEach(function(comment) {
		        const commentItem = document.createElement('div');
		        commentItem.classList.add('comment-item');
		
		        const imgContainer = document.createElement('div');
		        imgContainer.classList.add('img-container'); // 클래스 추가
		
		        // 이미지 요소 생성
		        const img = document.createElement('img');
		        img.classList.add('comment-thumb');
		        img.src = comment.memberProfilePath;
		        img.alt = '프로필 사진';
		
		        // 이미지 요소를 이미지 컨테이너 div에 추가
		        imgContainer.appendChild(img);
		
		        // 이제 이미지 컨테이너를 commentItem에 추가
		        commentItem.appendChild(imgContainer);
		
		        const contentDiv = document.createElement('div');
		        contentDiv.classList.add('comment-content');
		
		        const authorDiv = document.createElement('div');
		        authorDiv.classList.add('comment-author');
		        authorDiv.textContent = comment.memberName;
		        contentDiv.appendChild(authorDiv);
		
		        const messageDiv = document.createElement('div');
		        messageDiv.classList.add('comment-message');
		        messageDiv.textContent = comment.replyContent;
		        contentDiv.appendChild(messageDiv);
		
		        const infoDiv = document.createElement('div');
		        infoDiv.classList.add('comment-info');
		        infoDiv.textContent = comment.formatDate;
		        contentDiv.appendChild(infoDiv);
		
				if (memberId && memberId === comment.memberId) {
				    // 드롭다운 컨테이너 div
				    const dropdownContainer = document.createElement('div');
				    dropdownContainer.classList.add('comment-dropdown-container');
				
				    // 드롭다운을 표시하는 버튼
				    const commentButton = document.createElement('button');
				    commentButton.classList.add('comment-action-button');
				    commentButton.style.backgroundImage = 'url("image/seongun/replyButton.svg")'; // 가정한 경로입니다.
				
				    // 드롭다운 메뉴
				    const dropdownMenu = document.createElement('ul');
				    dropdownMenu.classList.add('dropdown-menu');
				
				    // 수정 옵션
				    const editItem = document.createElement('li');
				    const editButton = document.createElement('button');
				    editButton.textContent = '수정';
				    editButton.classList.add('dropdown-item');
				    editButton.classList.add('reply-update');
				    editButton.onclick = function() {
				    	// 기존 댓글 내용을 저장합니다.
				    	const originalContent = messageDiv.textContent;
				
				    	// 댓글 수정 폼을 생성합니다.
				    	const editForm = document.createElement('div');
				    	editForm.classList.add('comment-edit-form');
				
				    	// 텍스트 입력 영역 생성
				    	const textarea = document.createElement('textarea');
				    	textarea.classList.add('comment-input');
				    	textarea.value = originalContent; // 기존 댓글 내용으로 초기화합니다.
				
				    	// 버튼들을 감쌀 컨테이너 생성
				    	const buttonsContainer = document.createElement('div');
				    	buttonsContainer.classList.add('buttons-container');
				
				    	// '등록' 버튼 생성
				    	const submitButton = document.createElement('button');
				    	submitButton.type = 'button';
				    	submitButton.classList.add('update-submit');
				    	submitButton.textContent = '등록';
				    	submitButton.onclick = function() {
				    	    // 서버에 수정 내용을 전송하는 코드를 여기에 추가합니다.
				    	    let text = textarea.value
				    	    updateReply(text, comment);
				    	    // 수정된 내용으로 댓글을 업데이트합니다.
				    	    messageDiv.textContent = textarea.value;
				    	    contentDiv.replaceChild(messageDiv, editForm);
				    	};
				
				    	// '취소' 버튼 생성
				    	const cancelButton = document.createElement('button');
				    	cancelButton.type = 'button';
				    	cancelButton.classList.add('comment-cancel');
				    	cancelButton.textContent = '취소';
				    	cancelButton.onclick = function() {
				    	    contentDiv.replaceChild(messageDiv, editForm);
				    	    
				    	};
				
				    	// 버튼들을 컨테이너에 추가
				    	buttonsContainer.appendChild(submitButton);
				    	buttonsContainer.appendChild(cancelButton);
				
				    	// 수정 폼에 텍스트 영역과 버튼 컨테이너를 추가합니다.
				    	editForm.appendChild(textarea);
				    	editForm.appendChild(buttonsContainer);
				
				    	// 기존 댓글 내용을 수정 폼으로 대체합니다.
				    	contentDiv.replaceChild(editForm, messageDiv);
				
				    };
				
				    // 삭제 옵션
				    const deleteItem = document.createElement('li');
				    const deleteButton = document.createElement('button');
				    deleteButton.textContent = '삭제';
				    deleteButton.classList.add('dropdown-item');
				    deleteButton.classList.add('reply-del');
				    deleteButton.onclick = function() {
				        if(confirm("댓글을 삭제 하시겠습니까?")){
				        	deleteReply(comment);
				        }
				    };
				
				    // 옵션을 드롭다운 메뉴에 추가
				    editItem.appendChild(editButton);
				    deleteItem.appendChild(deleteButton);
				    dropdownMenu.appendChild(editItem);
				    dropdownMenu.appendChild(deleteItem);
				
				    // 드롭다운 메뉴를 표시하고 숨기는 로직
				    commentButton.onclick = function(event) {
				        const isDisplayed = dropdownMenu.style.display === 'block';
				        dropdownMenu.style.display = isDisplayed ? 'none' : 'block';
				        event.stopPropagation();
				    };
				
				    // 클릭 이벤트가 버블링되지 않도록 합니다.
				    document.addEventListener('click', function(event) {
				        if (!dropdownContainer.contains(event.target)) {
				            dropdownMenu.style.display = 'none';
				        }
				    });
				
				    // 드롭다운 컨테이너에 버튼과 메뉴를 추가
				    dropdownContainer.appendChild(commentButton);
				    dropdownContainer.appendChild(dropdownMenu);
				
				    // 컨테이너를 contentDiv에 추가
				    contentDiv.appendChild(dropdownContainer);
				}
		
		
		        commentItem.appendChild(contentDiv);
		        commentList.appendChild(commentItem);
		    });
		}
				
		function formatDate(dateString) {
		    const date = new Date(dateString);

		    const formattedDate = date.getFullYear() + '-' +
		                          (date.getMonth() + 1).toString().padStart(2, '0') + '-' +
		                          date.getDate().toString().padStart(2, '0') + ' ' +
		                          date.getHours().toString().padStart(2, '0') + ':' +
		                          date.getMinutes().toString().padStart(2, '0');

		    return formattedDate;
		}

		
		//댓글 페이징 처리
		function updatePagination(rPi) {
		    const paginationDiv = document.getElementById('pagenation');
		    paginationDiv.innerHTML = '';
		
		    // 이전 페이지 그룹 버튼 컨테이너
		    const prevGroupDiv = document.createElement('div');
		    prevGroupDiv.className = 'page-nav-buttons';
		    paginationDiv.appendChild(prevGroupDiv);
		
		    // 페이지 번호를 담을 ul 요소
		    const ul = document.createElement('ul');
		    ul.className = 'page-numbers';
		    paginationDiv.appendChild(ul);
		
		    // 다음 페이지 그룹 버튼 컨테이너
		    const nextGroupDiv = document.createElement('div');
		    nextGroupDiv.className = 'page-nav-buttons';
		    paginationDiv.appendChild(nextGroupDiv);
		
		    const pageLimit = rPi.pageLimit;
		    const totalPageGroups = Math.ceil(rPi.maxPage / pageLimit);
		    const currentPageGroup = Math.ceil(rPi.currentPage / pageLimit);
		
		    // 이전 페이지 그룹으로 이동
		    if (currentPageGroup > 1) {
		        const prevGroupLink = document.createElement('a');
		        prevGroupLink.href = '#';
		        prevGroupLink.innerHTML = '&lt; 이전';
		        prevGroupLink.onclick = function(event) {
		            event.preventDefault();
		            const prevPage = (currentPageGroup - 1) * pageLimit - (pageLimit - 1);
		            loadCommentList(prevPage);
		        };
		        prevGroupDiv.appendChild(prevGroupLink);
		    }
		
		    // 페이지 번호
		    let startPage = (currentPageGroup - 1) * pageLimit + 1;
		    let endPage = startPage + pageLimit - 1;
		    endPage = endPage > rPi.maxPage ? rPi.maxPage : endPage;
		
		    for (let i = startPage; i <= endPage; i++) {
		        const pageLi = document.createElement('li');
		        const pageLink = document.createElement('a');
		        pageLink.href = '#';
		        pageLink.textContent = i;
		        if (i === rPi.currentPage) {
		            pageLink.id = 'check_page';
		        }
		        pageLink.onclick = function(event) {
		            event.preventDefault();
		            loadCommentList(i);
		        };
		        pageLi.appendChild(pageLink);
		        ul.appendChild(pageLi);
		    }
		
		    // 다음 페이지 그룹으로 이동
		    if (currentPageGroup < totalPageGroups) {
		        const nextGroupLink = document.createElement('a');
		        nextGroupLink.href = '#';
		        nextGroupLink.innerHTML = '다음 &gt;';
		        nextGroupLink.onclick = function(event) {
		            event.preventDefault();
		            const nextPage = currentPageGroup * pageLimit + 1;
		            loadCommentList(nextPage);
		        };
		        nextGroupDiv.appendChild(nextGroupLink);
		    }
		}
		
		function updateReply(text, comment){
			$.ajax({
				url: 'updateReply.rep',
				method: 'POST',
				data: {
					replyContent: text,
					boardNo: comment.boardNo, 
					boardType: 1,
					replyNo: comment.replyNo
				},
				success: function(data) {
					if(data >0){
						loadCommentList(data);
					}else{
						alert("댓글 수정의 실패했습니다. 다시 시도해주세요.")
					}
				},
				error: function(error) {
					alert("댓글을 500자 이내로 입력해주세요!");
				}
			});
		}
		
		function deleteReply(comment){
			$.ajax({
				url: 'deleteReply.rep',
				method: 'POST',
				data: {
					boardNo: comment.boardNo, 
					boardType: 1,
					replyNo: comment.replyNo
				},
				success: function(data) {
					if(data > 0){
						alert("댓글이 삭제되었습니다.")
						loadCommentList(data);
					}else{
						alert("댓글 수정의 실패했습니다. 다시 시도해주세요.");
					}
				},
				error: function(error) {
					console.error('Error adding comment:', error);
				}
			});
		}
	</script>
</body>
</html>
