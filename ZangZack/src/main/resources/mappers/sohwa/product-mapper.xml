<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.zangzac.sohwa.product.model.dao.ProductDAO">


	<insert id="insertProduct">
		<!-- order : insert/update를 하기 전에 selectKey를 수행할 것인지, 후에 수행할 것인지 (before : insert하기전에 수행) -->
	    <!-- keyProperty : 가져온 값을 필드에 대입하기 위해서 selectKey를 하는 것임. 어디에 집어넣을지를 적어놓어주는 곳 -->
		<selectKey order="BEFORE" resultType="_int" keyProperty="productNo">
			select product_seq.nextval from dual
		</selectKey>
		<!-- 이미 시퀀스로 하나 올려진 글번호를 prodcutNo필드에 대입을 했으므로 시퀀스 돌려주는게(product_seq.nextval) 아니라 productNo 넣어주면 된다. -->
		insert into product
		values (#{productNo}, #{productName}, #{productPrice}, sysdate, default, #{productScore}, #{categoryNo}, #{productCompany}, #{deliveryPrice}, #{eno})
	</insert>
	
	
	<insert id="insertProductPhoto">
	<!-- 유의해야할 점 : insert all안에서 시퀀스 사용하게 되면 시퀀스 한 번만 작동돼서
		     계속 같은 값을 내뱉음. 따라서, 그냥 photo_seq.nextval로 photo_no 지정하게 되면 무결성 제약조건 오류남. 
		     oracle로 가서 아래와 같이 함수 만들어준다.
		     
		     create or replace function new_aid
			 return number
			 is
			     new_aid number;
			 begin
			     select photo_seq.nextval
			     into new_aid
			     from dual;
			    
			     return new_aid;
			 end;-->
		insert all
		
		<foreach collection="list" item="item">
			into photo
			values (new_aid,  #{ item.photoRename }, #{item.photoPath}, #{item.photoLevel}, 5, #{item.boardNo}, default)
		</foreach>
		select * from dual
	</insert>
	
	
	<insert id="updateReviewPhoto">
	    insert into photo
	    values (new_aid, #{photoRename}, #{photoPath}, 0, 6, #{boardNo}, default)
	</insert>
	
	
	
	<update id="updateReviewInfo">
		update review
		set review_content=#{reviewContent} , review_score=#{reviewScore}, review_modify_date = sysdate
		where review_no = #{reviewNo}
	</update>
	
	<delete id="deleteReviewPhoto">
		delete from photo
		where board_type = 6 and board_no = #{reviewNo}
	</delete>
	
	<select id="deleteSelectReview" resultType="string">
		select photo_rename
        from photo
        where board_type = 6 and board_no=#{review_no}
	</select>
	
	
	<insert id="insertOption">
		<!-- 유의해야할 점 : insert all안에서 시퀀스 사용하게 되면 시퀀스 한 번만 작동돼서
	     계속 같은 값을 내뱉음. 따라서, 그냥 photo_seq.nextval로 photo_no 지정하게 되면 무결성 제약조건 오류남. 
	     oracle로 가서 아래와 같이 함수 만들어준다.
	     
	     create or replace function option_aid
		 return number
		 is
		     option_aid number;
		 begin
		     select product_option_seq.nextval
		     into option_aid
		     from dual;
		    
		     return option_aid;
		 end;-->
		insert all
		<foreach collection="list" item="item">
			into product_option
			values(option_aid, #{item.productOptionColor}, #{item.productOptionEno}, #{item.productNo})
		</foreach>
		select * from dual
		
	</insert>
	
	
	
	
	
	<select id="getListCount" resultType="_int">
		select count(*)
		from product
		where product_status = 'N'
		<if test="categoryNo != 0">
			and category_no=#{categoryNo}
		</if>
	</select>
	
	
	
	
	<select id="getListCountKeyword" resultType="_int">
		select count(*)
		from product
		where product_status = 'N' and product_name like '%${keyword}%'
	</select>
	
	
	
	<select id="searchProduct" resultType="Product">
		select *
		from product
			 JOIN camping_category using (category_no)
		where product_status = 'N' and product_name like '%${keyword}%'
		<if test="standard==1">
			order by product_no desc
		</if>
		<if test="standard==2">
			order by product_price
		</if>
		<if test="standard==3">
			order by product_price desc
		</if>
		<if test="standard==4">
			order by product_score desc
		</if>
	</select>
	
	
	<select id="searchPhoto" resultType="Attachment">
		select *
		from photo
			 join product on (board_no = product_no)
		where photo_status = 'N' and product_name like '%${keyword}%' and photo_level =0
		<if test="standard==1">
			order by product_no desc
		</if>
		<if test="standard==2">
			order by product_price
		</if>
		<if test="standard==3">
			order by product_price desc
		</if>
		<if test="standard==4">
			order by product_score desc
		</if>
	</select>
	
	<select id="searchPhototh" resultType="Attachment">
		select *
		from photo
			 join product on (board_no = product_no)
		where photo_status = 'N' and product_name like '%${keyword}%' and photo_level in (0,1)
		<if test="standard==1">
			order by product_no desc
		</if>
		<if test="standard==2">
			order by product_price
		</if>
		<if test="standard==3">
			order by product_price desc
		</if>
		<if test="standard==4">
			order by product_score desc
		</if>
	</select>
	
	
	
	<select id="selectProductList" resultType="Product">
		select *
		from product
			 JOIN camping_category using (category_no)
		where product_status = 'N'
		<if test="categoryNo != 0">
			and category_no = #{categoryNo}
		</if>
		<if test="standard==1">
			order by product_no desc
		</if>
		<if test="standard==2">
			order by product_price
		</if>
		<if test="standard==3">
			order by product_price desc
		</if>
		<if test="standard==4">
			order by product_score desc
		</if>
		
	</select>	
	
	
	
	
	<select id="selectPhotoList" resultType="Attachment">
		select *
		from photo
			 join product on (product_no = board_no)
		where photo_status = 'N' and photo_level = 0
		<if test="categoryNo != 0">
			and category_no = #{categoryNo}
		</if>
		order by board_no
	</select>
	
	<select id="selectPhotothList" resultType="Attachment">
		select *
		from photo
			 join product on (product_no = board_no)
		where photo_status = 'N' and photo_level in (0,1)
		<if test="categoryNo != 0">
			and category_no = #{categoryNo}
		</if>
		order by board_no
	</select>
	
	
	<select id="selectProductDetail" resultType="Product">
		select *
		from product
		where product_no = #{productNo}
	</select>
	
	
	<select id="selectPhotoDetail" resultType="Attachment">
		select *
		from photo
			  join product on (product_no = board_no)
		where product_no = #{productNo} and photo_status='N'
	</select>
	
	<select id="selectPhotoReview" resultType="Attachment">
		select *
		from photo 
			 join review on (review_no = board_no)
		where product_No = #{productNo} and photo_status='N'
	</select>
	
	<select id="optionDetail" resultType="Option">
		select *
		from product_option
		where product_no = #{productNo}
	</select>
	
	
	
	<select id="selectReviewMember" resultType="Member">
		select *
        from member
             join review using (member_id)
             where product_no = #{productNo}
	</select>
	
	
	
	
	
	
	<select id="selectAllProduct" resultType="Product">
		select *
		from product
		where product_status = 'N'
	</select>
	
	
	<select id="selectAllPhoto" resultType="Attachment">
		select *
		from photo
			 join product on (board_no = product_no)
		where product_status='N'
	</select>
	
	<select id="selectProductOption" resultType="Option">
		select *
		from option
		where product_no = #{productNo}
	</select>
	
	<select id="selectDeleteProduct" resultType="Product">
		select *
		from product
		where product_status = 'Y'
	</select>
	
	<select id="selectDeletePhoto" resultType="Attachment">
		select *
		from photo
			 join product on (board_no = product_no)
		where product_status='Y'
	</select>
	
	
	
	
	<insert id="insertCart">
		insert into cart
		values(cart_key_seq.nextval, #{productNo}, #{memberId}, #{productEno}, #{buyOption}, #{buyPrice})
	</insert>
	
	<select id="memberCart" resultType="Cart">
      select *
      from cart 
          join product using (product_no)
          join photo on (board_no=product_no)
      where member_id=#{id} and photo_level=0 and photo_status='N'
   </select>
   
   <select id="selectAllOption">
      select *
      from product_option
   </select>
   
   
   <delete id="deleteCart">
   	  delete from cart
   	  where cart_key_no = #{cartKeyNo}
   </delete>
   
   
   <delete id="deleteCarts">
   	   DELETE FROM cart
       WHERE cart_Key_No IN
   	   <foreach collection="list" item="cartKeyNo" open="(" close=")" separator=",">
        	#{cartKeyNo}
       </foreach>
   </delete>
   
   <update id="updateCartEno">
   	   update cart
   	   set buy_price = #{buyPrice} , product_eno = #{productEno}
   	   where cart_key_no = #{cartKeyNo}
   </update>
	
	
	<insert id="insertQna">
		insert into qna
		values(question_seq.nextval, #{questionContent}, sysdate, null, null, default, #{memberId} ,#{productNo})
	</insert>
	
	
	<select id="selectMyQna" resultType="Qna">
		select *
		from qna
		where member_id=#{memberId} and qna_status = 'N'
		order by question_no desc
	</select>
	
	
	<select id="getListQnaCount" resultType="_int">
		select count(*)
		from qna
		where qna_status='N' and answer_content is null
	</select>
	
	<select id="getListQnaYCount" resultType="_int">
		select count(*)
		from qna
		where qna_status='N' and answer_content is not null
	</select>
	
	
	<select id="selectQna" resultType="Qna">
		select *
		from qna
		where qna_status = 'N' and answer_content is null
		order by question_no
	</select>
	
	<select id="searchKeyword" resultType="Qna">
		select *
		from qna
			 join product using (product_no)
		where qna_status = 'N' and answer_content is null 
		<if test="searchType==1">
			and product_name like '%${keyword}%'
		</if>
		<if test="searchType==2">
			and question_content like '%${keyword}%'
		</if>
		<if test="searchType==3">
			and product_no like '%${keyword}%'
		</if>
		order by question_no
	</select>
	
	<select id="selectQnaY" resultType="Qna">
		select *
		from qna
		where qna_status = 'N' and answer_content is not null
		order by question_no
	</select>
	
	<select id="searchYKeyword" resultType="Qna">
		select *
		from qna
			 join product using (product_no)
		where qna_status = 'N' and answer_content is not null 
		<if test="searchType==1">
			and product_name like '%${keyword}%'
		</if>
		<if test="searchType==2">
			and question_content like '%${keyword}%'
		</if>
		<if test="searchType==3">
			and product_no like '%${keyword}%'
		</if>
		order by question_no
	</select>
	
	<update id="updateAnswer">
		update qna
		set answer_content=#{answerContent}, answer_date = sysdate
		where question_no = #{questionNo} and question_status ='N'
	</update>
	
	<select id="selectProductQna" resultType="Qna">
		select * 
		from qna
		where product_no = #{productNo} and qna_status = 'N'
		order by question_no
	</select>
	
	<update id="deleteQna">
		update qna
		set qna_status = 'Y'
		where question_no = #{questionNo}
	</update>
	
	<insert id="insertReview">
	
		<!-- order : insert/update를 하기 전에 selectKey를 수행할 것인지, 후에 수행할 것인지 (before : insert하기전에 수행) -->
	    <!-- keyProperty : 가져온 값을 필드에 대입하기 위해서 selectKey를 하는 것임. 어디에 집어넣을지를 적어놓어주는 곳 -->
		<selectKey order="BEFORE" resultType="_int" keyProperty="reviewNo">
			select review_seq.nextval from dual
		</selectKey>
		<!-- 이미 시퀀스로 하나 올려진 글번호를 prodcutNo필드에 대입을 했으므로 시퀀스 돌려주는게(product_seq.nextval) 아니라 productNo 넣어주면 된다. -->
		insert into review
		values (#{reviewNo}, #{reviewContent}, sysdate, #{reviewScore}, null, default, #{productNo}, #{memberId})
	</insert>
	
	<insert id="insertReviewPhoto">
		insert into photo
		values (new_aid,  #{ photoRename }, #{photoPath}, #{photoLevel}, 6, #{ boardNo }, default)
	</insert>
	
	
	<select id="selectProductReview" resultType="Review">
		select *
		from review
		where product_no = #{productNo} and review_status = 'N'
		order by review_no desc
	</select>
	
	
	<select id="selectProductPhotoReview" resultType="Review">
		select *
		from review
			 join photo on (board_no = review_no)
		where product_no = #{productNo} and review_status = 'N' and board_type=6
		order by review_no desc
	</select>
	
	
	<select id="selectAllProductScore" resultType="_int">
		select review_score
		from review
		where product_no = #{productNo} and review_status = 'N'
	</select>
	
	<update id="updateScore">
		update product
		set product_score = #{productScore}
		where product_no = #{productNo}
	</update>
	
	<select id="selectProductAllReview" resultType="Review">
		select *
		from review
		where review_status = 'N'
	</select>
	
	
	<update id="deleteReview">
		update review
		set review_status = 'Y'
		where review_no = #{reviewNo}
	</update>
	
	<update id="updateYProduct">
		update product
		set product_status='Y'
		where product_no in
		<foreach item="productNo" collection="list" open="(" separator="," close=")">
			#{productNo}
		</foreach>
	</update>
	
	<select id="selectYPhoto" resultType="string">
		select photo_rename
		from photo
		where board_type = 5 and board_no in
		<foreach collection="list" item="productNo"  open="(" separator="," close=")">
			#{productNo}
		</foreach>
	</select>
	
	<update id="updateYPhoto">
		update photo
		set photo_status='Y'
		where board_type=5 and board_no in
		<foreach collection="list" item="productNo"  open="(" separator="," close=")">
			#{productNo}
		</foreach>
	</update>
	
	<delete id="deleteOption">
		delete from product_option
		where product_no = #{productNo}
	</delete>
	
	
	<update id="deleteProductPhoto">
		update photo
		set photo_status = 'Y'
		where photo_rename in
		<foreach item="rename" collection="list" open="(" separator="," close=")">
			#{rename}
		</foreach>
	</update>
	
	<update id="updateProductPhotoY">
		update photo
		set photo_status = 'N'
		where photo_rename in
		<foreach item="item" collection="list" open="(" separator="," close=")">
			#{item.photoRename}
		</foreach>
	</update>
	
	<update id="updateProduct">
		update product
		set product_name = #{productName} , product_price= #{productPrice}, category_no = #{categoryNo}, product_company=#{productCompany}, delivery_price = #{deliveryPrice}
		where product_no = #{productNo} and product_status = 'Y'
	</update>
	
</mapper>